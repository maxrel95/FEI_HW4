library(dplyr)
library(tibble)
library(did)
library(conleyreg)
library(gridExtra)
library(ggplot2)
library(fixest)
library(estimatr)
library(data.table) 
library(readxl)

############### data cleaning ###############
dataTable = as.data.table( fread( "/Users/maxime/Documents/Université/HEC/PhD/6.1/FE I/HW4/JS_data.csv" ) )

df = dataTable %>%
  group_by( state ) %>%
  mutate( realIncome = pi_percap / cpi, 
          realGrowthIncome = 100 * realIncome / lag( realIncome ) ) %>%
  na.omit() %>%
  ungroup()

############### regressions ###############
r1ClusteredExclude = feols( realGrowthIncome ~ d | state + year,
          data = df %>% filter(year >= 1972 & year <= 1992,
                                                state != "Delaware",
                                                year != ma),
          vcov = cluster ~ state + year )

r1RobustExclude = feols( realGrowthIncome ~ d | state + year,
            data = df %>% filter(year >= 1972 & year <= 1992,
                                 state != "Delaware",
                                 year != ma),
            vcov = "hetero" )

r1ClusteredInclude = feols( realGrowthIncome ~ d | state + year,
                     data = df %>% filter(year >= 1972 & year <= 1992,
                                          state != "Delaware"),
                     vcov = cluster ~ state + year )

r1RobustInclude = feols( realGrowthIncome ~ d | state + year,
                  data = df %>% filter(year >= 1972 & year <= 1992,
                                       state != "Delaware"),
                  vcov = "hetero" )

etable( r1ClusteredExclude, r1RobustExclude, r1ClusteredInclude, r1RobustInclude )

r1ClusteredExcludeRegional = feols( realGrowthIncome ~ d | state + s^year + mw^year + w^year + ne^year,
                            data = df %>% filter(year >= 1972 & year <= 1992,
                                                 state != "Delaware",
                                                 year != ma,
                                                 state != "Alaska",
                                                 state != "Hawaii"),
                            vcov = cluster ~ state + year )

r1RobustExcludeRegional = feols( realGrowthIncome ~ d | state + s^year + mw^year + w^year + ne^year,
                                    data = df %>% filter(year >= 1972 & year <= 1992,
                                                         state != "Delaware",
                                                         year != ma,
                                                         state != "Alaska",
                                                         state != "Hawaii"),
                                    vcov = "hetero" )

r1ClusteredIncludeRegional = feols( realGrowthIncome ~ d | state + s^year + mw^year + w^year + ne^year,
                                    data = df %>% filter(year >= 1972 & year <= 1992,
                                                         state != "Delaware",
                                                         state != "Alaska",
                                                         state != "Hawaii"),
                                    vcov = cluster ~ state + year )

r1RobustIncludeRegional = feols( realGrowthIncome ~ d | state + s^year + mw^year + w^year + ne^year,
                                 data = df %>% filter(year >= 1972 & year <= 1992,
                                                      state != "Delaware",
                                                      state != "Alaska",
                                                      state != "Hawaii"),
                                 vcov = "hetero" )

etable( r1ClusteredExcludeRegional, r1RobustExcludeRegional,  r1ClusteredIncludeRegional, r1RobustIncludeRegional )
